<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- Googleサイト所有権確認 -->
<meta name="google-site-verification" content="4U4miU3Gsc0UAXRYGq5Y5ezYuwDvyN93D19iR8COO4E" />

<!-- サイト説明（検索結果で表示される可能性があります。必要に応じて変更してください） -->
<meta name="description" content="ChatGPT風のシンプルなローカルチャットUI。会話のローカル保存、エクスポート/インポート、Enter送信などの基本機能を備え、外部API接続用のフックを用意しています。" />

<title>ChatGPT風チャット</title>
<style>
  :root{
    --bg:#0f1724;
    --panel:#0b1220;
    --muted:#94a3b8;
    --accent:#10b981; /* green */
    --user-bg:#0ea5ff;
    --assistant-bg:#152233;
    --bubble-text:#e6eef8;
    --radius:14px;
    --glass: rgba(255,255,255,0.03);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Arial", sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#061025 0%, #071028 60%);color:var(--bubble-text)}
  .app {
    max-width:1000px;margin:28px auto;padding:18px;display:grid;grid-template-columns:280px 1fr;gap:18px;
  }

  /* Sidebar */
  .sidebar{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;padding:14px;height:80vh;display:flex;flex-direction:column;
    box-shadow:0 6px 20px rgba(2,6,23,0.6);
  }
  .brand{display:flex;align-items:center;gap:10px;padding:6px 4px;margin-bottom:12px}
  .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700;color:#042a2b}
  .title{font-weight:700;font-size:1rem}
  .desc{font-size:12px;color:var(--muted);margin-top:6px}
  .controls{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
  button.btn{
    background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:var(--bubble-text);padding:8px 10px;border-radius:8px;font-size:13px;cursor:pointer;
  }
  button.btn:active{transform:translateY(1px)}
  .preset-list{margin-top:12px;overflow:auto;padding-right:6px}
  .preset{background:transparent;border:1px dashed rgba(255,255,255,0.03);padding:8px;border-radius:10px;margin-bottom:8px;cursor:pointer;color:var(--muted);font-size:13px}

  /* Main panel */
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;padding:14px;height:80vh;display:flex;flex-direction:column;
    box-shadow:0 6px 20px rgba(2,6,23,0.6);
  }
  .panel-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .panel-head h2{margin:0;font-size:1rem}
  .panel-body{flex:1;overflow:auto;padding:12px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);display:flex;flex-direction:column;gap:12px}
  .messages{display:flex;flex-direction:column;gap:12px}

  .msg{
    max-width:78%;padding:12px;border-radius:12px;display:flex;gap:10px;align-items:flex-start;
    box-shadow: 0 4px 16px rgba(2,6,23,0.4);
  }
  .msg.user{margin-left:auto;border-bottom-right-radius:4px;background:linear-gradient(180deg,var(--user-bg),#0284c7);color:white}
  .msg.assistant{margin-right:auto;background:linear-gradient(180deg,var(--assistant-bg),#0e2436);color:var(--bubble-text)}
  .meta{display:flex;flex-direction:column;gap:6px}
  .avatar{width:36px;height:36px;border-radius:9px;flex:0 0 36px;display:flex;align-items:center;justify-content:center;font-weight:700;background:rgba(255,255,255,0.03);color:var(--muted)}
  .bubble{white-space:pre-wrap;font-size:14px;line-height:1.5;}
  .bubble code{background:rgba(255,255,255,0.04);padding:2px 6px;border-radius:6px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Noto Sans Mono", monospace;font-size:13px;}
  .bubble pre{background:#071229;padding:10px;border-radius:8px;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;font-size:13px}
  .actions{display:flex;gap:8px;align-items:center;margin-top:8px}
  .muted{font-size:12px;color:var(--muted)}

  /* Input area */
  .composer{display:flex;gap:10px;align-items:flex-end;padding-top:8px}
  .composer textarea{
    flex:1;min-height:48px;max-height:160px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--bubble-text);resize:none;font-size:14px;line-height:1.4;
  }
  .composer .send{
    background:linear-gradient(180deg,var(--accent),#06b6d4);border:none;padding:10px 14px;border-radius:10px;color:#042a2b;font-weight:700;cursor:pointer;
  }
  .composer .send:active{transform:translateY(1px)}

  /* typing dots */
  .typing{display:inline-flex;gap:4px;align-items:center}
  .dot{width:8px;height:8px;border-radius:50%;background:#94a3b8;opacity:0.6;animation:blink 1s infinite}
  .dot:nth-child(2){animation-delay:0.15s}
  .dot:nth-child(3){animation-delay:0.3s}
  @keyframes blink{0%{opacity:0.2}50%{opacity:1}100%{opacity:0.2}}

  /* responsive */
  @media (max-width:880px){
    .app{grid-template-columns:1fr; padding:12px}
    .sidebar{height:auto;order:2}
    .panel{order:1;height:72vh}
  }
</style>
</head>
<body>
<div class="app" role="application" aria-label="ChatGPT風チャットアプリ">
  <aside class="sidebar" aria-label="サイドバー">
    <div class="brand">
      <div class="logo">CG</div>
      <div>
        <div class="title">ChatGPT風チャット</div>
        <div class="desc">シンプルなローカルUI — ダミー応答または自分のAPIに接続可能</div>
      </div>
    </div>

    <div class="controls">
      <button class="btn" id="new-chat">新しいチャット</button>
      <button class="btn" id="export">エクスポート</button>
      <button class="btn" id="import">インポート</button>
      <button class="btn" id="clear">全クリア</button>
    </div>

    <div style="margin-top:12px;color:var(--muted);font-size:13px">プリセット(クリックで挿入)</div>
    <div class="preset-list" id="presets">
      <div class="preset" data-text="自己紹介して">自己紹介して</div>
      <div class="preset" data-text="簡単な日英翻訳をして">日英翻訳: 簡単な文章</div>
      <div class="preset" data-text="プログラミングの勉強法を教えて">プログラミングの勉強法</div>
      <div class="preset" data-text="学校の宿題を手伝って">宿題の手伝い</div>
    </div>
    <div style="margin-top:auto;color:var(--muted);font-size:12px">保存はこのブラウザの localStorage に行われます。</div>
  </aside>

  <main class="panel" aria-live="polite">
    <div class="panel-head">
      <h2>Chat</h2>
      <div class="muted">Enterで送信 • Shift+Enterで改行</div>
    </div>

    <div class="panel-body">
      <div class="messages" id="messages" role="log" aria-live="polite"></div>
      <div class="composer" aria-label="メッセージ作成領域">
        <textarea id="input" placeholder="メッセージを入力..." aria-label="メッセージ入力"></textarea>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="send" id="sendBtn" title="送信">送信</button>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
/*
  ChatGPT風チャット — シングルHTMLファイル
  機能:
    - メッセージの送受信（ダミー応答）
    - Enterで送信、Shift+Enterで改行
    - localStorageへ保存 / 読み込み
    - エクスポート・インポート・全削除
    - Markdown風の簡易レンダリング（コードブロック, inline code, URL）
    - 外部APIを使う場合のhookポイントあり（コメント参照）
*/

// ----- util -----
const $ = sel => document.querySelector(sel);
const messagesEl = $('#messages');
const inputEl = $('#input');
const sendBtn = $('#sendBtn');

function escapeHtml(str){
  return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

// ミニ Markdown -> HTML 変換（安全にエスケープした後に簡易変換）
function renderMessage(text){
  // 保守: まず全体をエスケープ
  let s = escapeHtml(text);

  // コードブロック ```lang\n...\n```
  s = s.replace(/```([^\n\r]*)\n([\s\S]*?)```/g, (m, lang, code) => {
    return '<pre><code>' + escapeHtml(code) + '</code></pre>';
  });

  // inline code `code`
  s = s.replace(/`([^`]+)`/g, (m, code) => {
    return '<code>' + escapeHtml(code) + '</code>';
  });

  // URL -> aタグ
  s = s.replace(/(https?:\/\/[^\s]+)/g, (m) => {
    const url = m;
    return '<a href="'+url+'" target="_blank" rel="noopener noreferrer">'+url+'</a>';
  });

  // シンプルな改行は <br>
  s = s.replace(/\n/g, '<br>');
  return s;
}

// messageオブジェクトをDOMに追加
function appendMessage(role, text, options = {}){
  const wrap = document.createElement('div');
  wrap.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
  wrap.setAttribute('data-role', role);

  const avatar = document.createElement('div');
  avatar.className = 'avatar';
  avatar.textContent = role === 'user' ? 'U' : 'A';

  const content = document.createElement('div');
  content.className = 'meta';
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.innerHTML = renderMessage(text);

  content.appendChild(bubble);

  // actions: コピーボタンなど
  const actions = document.createElement('div');
  actions.className = 'actions';
  const copyBtn = document.createElement('button');
  copyBtn.className = 'btn';
  copyBtn.textContent = 'コピー';
  copyBtn.addEventListener('click', () => {
    navigator.clipboard.writeText(text).then(()=> {
      copyBtn.textContent = 'コピー済';
      setTimeout(()=>copyBtn.textContent='コピー',1000);
    });
  });
  actions.appendChild(copyBtn);

  content.appendChild(actions);

  if(role === 'user'){
    wrap.appendChild(content);
    wrap.appendChild(avatar);
  } else {
    wrap.appendChild(avatar);
    wrap.appendChild(content);
  }

  messagesEl.appendChild(wrap);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// typing indicator element
function createTypingIndicator(){
  const wrap = document.createElement('div');
  wrap.className = 'msg assistant typing-indicator';
  const avatar = document.createElement('div');
  avatar.className = 'avatar';
  avatar.textContent = 'A';
  const content = document.createElement('div');
  content.className = 'meta';
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  const dots = document.createElement('div');
  dots.className = 'typing';
  dots.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
  bubble.appendChild(dots);
  content.appendChild(bubble);
  wrap.appendChild(avatar);
  wrap.appendChild(content);
  return wrap;
}

// localStorage 保存/読み込み
const STORAGE_KEY = 'cg_chat_history_v1';
function saveHistory(history){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
}
function loadHistory(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return [];
    return JSON.parse(raw);
  }catch(e){
    console.error('history load error', e);
    return [];
  }
}

function renderHistory(){
  messagesEl.innerHTML = '';
  const h = loadHistory();
  for(const msg of h){
    appendMessage(msg.role, msg.text);
  }
}

// 履歴に追加して保存
function pushHistory(role, text){
  const h = loadHistory();
  h.push({role, text, t: Date.now()});
  saveHistory(h);
  renderHistory(); // 再描画（シンプル）
}

// 簡易なダミー応答生成（ここを外部API呼び出しに差し替え可能）
function generateDummyReply(userText){
  const t = userText.toLowerCase();
  if(/(hello|hi|やあ|こんにちは)/.test(t)){
    return 'こんにちは！どんなことを手伝いましょうか？';
  }
  if(/(ありがとう|感謝)/.test(t)){
    return 'どういたしまして！他にも何かあれば教えてください。';
  }
  if(/(翻訳|translate|英語)/.test(t)){
    return '翻訳したい文章を教えてください。';
  }
  if(/(宿題|homework|手伝)/.test(t)){
    return '宿題の内容を教えてくれれば、考え方を一緒に整理します（答えを丸写しするのではなく理解を助けます）。';
  }
  // それ以外は短く要約して返す（ダミー）
  if(t.length > 120){
    return '長めのメッセージありがとうございます。要点を3つにまとめると:\n1. ...\n2. ...\n3. ...\n（これはダミーの要約です）';
  }
  return '（ダミー返信）: ' + userText.split(/\n/).slice(0,3).join(' ') + ' ... もっと詳しく知りたいですか？';
}

// メッセージ送信処理
let typingIndicator = null;
function sendMessage(){
  const text = inputEl.value.trim();
  if(!text) return;
  // 自分のメッセージを追加
  pushHistory('user', text);
  inputEl.value = '';
  inputEl.style.height = null;
  inputEl.focus();

  // タイピング表示
  typingIndicator = createTypingIndicator();
  messagesEl.appendChild(typingIndicator);
  messagesEl.scrollTop = messagesEl.scrollHeight;

  // ダミー応答（ここで外部APIを呼ぶ実装に置き換え可能）
  // --- 外部APIに接続する場合（例: OpenAI） ---
  // セキュリティのため、ブラウザに直接APIキーを置くのは危険です。サーバー経由でキーを保持することを推奨します。
  // fetch('YOUR_BACKEND/api/chat', { method:'POST', body: JSON.stringify({messages: [...]}) })
  //   .then(res=>res.json()).then(data => { assistantText = data.reply; ... })
  //
  // 今回はローカルでダミー応答を生成します。
  const delay = 700 + Math.min(2200, text.length * 20);
  setTimeout(()=>{
    const reply = generateDummyReply(text);
    if(typingIndicator && typingIndicator.parentNode) typingIndicator.parentNode.removeChild(typingIndicator);
    pushHistory('assistant', reply);
  }, delay);
}

// textarea 自動高さ調整
function autoResizeTextarea(){
  inputEl.style.height = 'auto';
  inputEl.style.height = (inputEl.scrollHeight) + 'px';
}

// イベント
sendBtn.addEventListener('click', sendMessage);
inputEl.addEventListener('input', autoResizeTextarea);
inputEl.addEventListener('keydown', (e) => {
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

// サイドバー操作
$('#new-chat').addEventListener('click', ()=>{
  if(confirm('新しいチャットを開始しますか？（現在の履歴は残ります）')){
    localStorage.removeItem(STORAGE_KEY);
    renderHistory();
  }
});
$('#clear').addEventListener('click', ()=>{
  if(confirm('全てのメッセージを消しますか？')){
    localStorage.removeItem(STORAGE_KEY);
    renderHistory();
  }
});
$('#export').addEventListener('click', ()=>{
  const data = loadHistory();
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'chat_export.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});
$('#import').addEventListener('click', ()=>{
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const json = JSON.parse(reader.result);
        if(!Array.isArray(json)) { alert('不正なファイルです'); return; }
        saveHistory(json);
        renderHistory();
        alert('インポート完了');
      }catch(err){
        alert('読み込みエラー: ' + err.message);
      }
    };
    reader.readAsText(file);
  };
  input.click();
});

// プリセットクリックで入力欄に挿入
document.querySelectorAll('.preset').forEach(el=>{
  el.addEventListener('click', () => {
    inputEl.value = el.dataset.text || '';
    autoResizeTextarea();
    inputEl.focus();
  });
});

// 初期レンダリング
renderHistory();

// ペーストで画像を貼るなどの拡張はここに追加可能（現状テキストのみ）
// 例: inputEl.addEventListener('paste', (e)=>{/* handle images */})

// アクセシビリティ: ページ読み込み時にフォーカス
window.addEventListener('load', ()=>{ inputEl.focus(); });

</script>
</body>
</html>
